# HTTPS Setup for Astro Demo

## Configuration

The Astro demo is configured to run on **HTTPS** using **mkcert** development certificates.

### Server Configuration

**File**: `astro.config.mjs`

```javascript
export default defineConfig({
  integrations: [svelte()],
  
  vite: {
    server: {
      host: 'dev.thepia.net',
      port: 4321,
      https: {
        key: readFileSync(resolve(__dirname, 'certs/dev.thepia.net-key.pem')),
        cert: readFileSync(resolve(__dirname, 'certs/dev.thepia.net.pem'))
      }
    }
  }
});
```

### Access URLs

When you run `pnpm dev`, the server will be available at:

- **Primary**: `https://dev.thepia.net:4321/`
- **Localhost**: `https://localhost:4321/`
- **Local network**: `https://thepia.local:4321/`

## Prerequisites

### 1. mkcert CA Installed

The mkcert CA must be installed in your system's trust store:

```bash
# Check if mkcert is installed
mkcert -CAROOT

# If not installed, install it
brew install mkcert
mkcert -install
```

### 2. /etc/hosts Entry

Add `dev.thepia.net` to your hosts file:

```bash
# Check if entry exists
grep dev.thepia.net /etc/hosts

# If not, add it
echo "127.0.0.1 dev.thepia.net" | sudo tee -a /etc/hosts
```

### 3. Certificates Present

The `certs/` directory should contain:

- `dev.thepia.net.pem` - Certificate
- `dev.thepia.net-key.pem` - Private key
- `dev.thepia.net.crt` - Certificate (alternative format)

## Why HTTPS?

### WebAuthn Requirements

- **Passkeys require HTTPS** - WebAuthn API only works over secure connections
- **Production-like testing** - Matches real-world authentication behavior
- **Browser security** - Modern browsers enforce HTTPS for sensitive APIs

### Domain Consistency

- **RP ID matching** - WebAuthn uses `thepia.net` as the Relying Party ID
- **Cookie scope** - Authentication cookies are scoped to `thepia.net`
- **CORS policies** - API server expects requests from `*.thepia.net` domains

## Troubleshooting

### Certificate Not Trusted

**Symptom**: Browser shows "Your connection is not private" warning

**Solution**:
```bash
# Verify mkcert CA is installed
security find-certificate -c "mkcert" /Library/Keychains/System.keychain

# If not found, reinstall
mkcert -install
```

### Port Already in Use

**Symptom**: `Port 4321 is in use, trying another one...`

**Solution**:
```bash
# Find what's using the port
lsof -i :4321

# Kill the process or use a different port
pnpm dev -- --port 4322
```

### dev.thepia.net Not Resolving

**Symptom**: `ERR_NAME_NOT_RESOLVED` or "Site can't be reached"

**Solution**:
```bash
# Check DNS resolution
nslookup dev.thepia.net

# Should return 127.0.0.1
# If not, add to /etc/hosts
echo "127.0.0.1 dev.thepia.net" | sudo tee -a /etc/hosts
```

### HTTPS Not Working

**Symptom**: Server starts on `http://` instead of `https://`

**Solution**:
1. Check that certificates exist in `certs/` directory
2. Verify `astro.config.mjs` has `vite.server.https` configuration
3. Ensure certificate files are readable

## Certificate Details

### Type
- **Development certificates** generated by mkcert
- **Not production certificates** - Only trusted on machines with mkcert CA installed

### Validity
- **Issued**: June 22, 2025
- **Expires**: September 22, 2027
- **Issuer**: mkcert development CA

### Security
- ‚úÖ Safe for development
- ‚úÖ Safe to commit to version control (development-only)
- ‚ùå Do NOT use in production
- ‚ùå Do NOT share private keys outside development team

## Verification

### Test HTTPS is Working

```bash
# Start the dev server
pnpm dev

# In another terminal, test the connection
curl -v https://dev.thepia.net:4321/

# Should return 200 OK with HTML content
```

### Test Certificate Trust

```bash
# Verify certificate chain
security verify-cert -c certs/dev.thepia.net.pem

# Should output: "...certificate verification successful."
```

### Test in Browser

1. Open `https://dev.thepia.net:4321/`
2. Check the address bar - should show üîí (lock icon)
3. Click the lock icon ‚Üí "Connection is secure"
4. Certificate should be issued by "mkcert development CA"

## Production Deployment

For production deployment on `dev.thepia.net`:

1. **Use Let's Encrypt** - Obtain real certificates via certbot
2. **Update DNS** - Point `dev.thepia.net` to production server
3. **SSL termination** - Configure at load balancer or reverse proxy
4. **Remove mkcert certs** - Don't deploy development certificates

---

**Last Updated**: October 1, 2025  
**Certificate Expiry**: September 22, 2027  
**Status**: ‚úÖ Working

