# SSL Certificates for Nets Offboarding Flows

## Overview

This directory contains SSL certificates for development of the Nets Offboarding Flows application on `dev.thepia.net`. These certificates enable HTTPS locally, which is required for WebAuthn functionality and production-like authentication testing.

## Certificate Files

### Primary Certificates (mkcert - locally trusted)
- `dev.thepia.net.crt` - SSL certificate for dev.thepia.net
- `dev.thepia.net-key.pem` - Private key for dev.thepia.net  
- `dev.thepia.net.pem` - Combined certificate and key file

### Additional Certificates (mkcert - locally trusted)
- `localhost.crt` - Certificate for localhost development
- `localhost-key.pem` - Private key for localhost
- `localhost.pem` - Combined localhost certificate
- `thepia.local.crt` - Certificate for thepia.local
- `thepia.local-key.pem` - Private key for thepia.local
- `thepia.local.pem` - Combined thepia.local certificate

## Certificate Expiration

**mkcert certificates**: Valid until mkcert CA expires (typically years)

These are development-only certificates generated by mkcert and are safe to check into version control.

## Quick Setup

### For New Developers

1. **Generate locally-trusted certificates**:
   ```bash
   pnpm setup:https
   ```
   This automatically installs mkcert and generates certificates that work without browser warnings.

2. **Add domain to /etc/hosts** (if needed):
   ```bash
   pnpm setup:mdns
   ```

3. **Start development server**:
   ```bash
   pnpm dev
   ```

4. **Access the application**:
   - Primary: https://dev.thepia.net:5173
   - Fallback: https://localhost:5173

### Regenerating Certificates

If you need fresh certificates:

```bash
# Generate mkcert certificates (preferred - no browser warnings)
pnpm setup:https

# Verify certificate trust status
pnpm trust:cert

# For production-like testing with real domain (advanced)
pnpm setup:letsencrypt
```

## Domain Configuration

### dev.thepia.net
- **Primary development domain**
- **Real Let's Encrypt certificates**
- **Production-like authentication behavior**
- **Required for WebAuthn testing**

### thepia.local
- **Local network access**
- **Self-signed certificates**
- **Fallback for offline development**
- **Works across local network**

### localhost
- **Local-only development**
- **Self-signed certificates**
- **Basic HTTPS testing**

## Why These Certificates Are Needed

### WebAuthn Requirements
- WebAuthn (passkeys) requires HTTPS in production
- Safari enforces strict HTTPS requirements
- Testing authentication flows needs production-like conditions

### thepia.net Domain Integration
- Flow tokens are domain-specific (thepia.net RP ID)
- CORS policies require consistent domains
- API server expects thepia.net authentication context

### Development Experience
- No "unsafe site" warnings
- Real SSL/TLS behavior testing
- Network accessibility for mobile testing

## Security Notes

### Safe for Version Control
- These are development-only certificates
- Domain is controlled by Thepia
- No production secrets or sensitive data

### Certificate Trust
- Certificates are added to macOS keychain as trusted
- Only affects local development environment
- Does not compromise system security

## Troubleshooting

### Certificate Not Trusted
```bash
# Re-trust certificates
pnpm trust:cert

# Or manually add to keychain
sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain certs/dev.thepia.net.crt
```

### "Site Can't Be Reached"
1. Check if dev.thepia.net resolves to localhost:
   ```bash
   nslookup dev.thepia.net
   ```

2. If not, add to `/etc/hosts`:
   ```bash
   echo "127.0.0.1 dev.thepia.net" | sudo tee -a /etc/hosts
   ```

### Port Conflicts
- Default port: 5173
- Alternative: Use `pnpm dev --port 3000`
- API port: 8443 (when using local API)

### Certificate Errors in CI
- CI environments use different certificate validation
- Use `NODE_TLS_REJECT_UNAUTHORIZED=0` for testing only
- Production deploys use real SSL termination

## Integration with API Server

When running with local API server:
- Frontend: https://dev.thepia.net:5173
- API: https://dev.thepia.net:8443
- Same domain eliminates CORS issues
- Consistent SSL/TLS configuration

## Scripts Reference

All scripts are available as package.json commands:

```bash
# Certificate generation
pnpm setup:letsencrypt    # Generate Let's Encrypt certificates
pnpm setup:https          # Generate self-signed certificates  
pnpm trust:cert           # Trust certificates in system keychain

# Development
pnpm dev                  # Start HTTPS development server
pnpm dev:https            # Start with explicit HTTPS config
pnpm api:local            # Start local API server with HTTPS

# Network access
pnpm setup:mdns           # Enable network-wide mDNS access
```

## File Structure

```
certs/
├── README.md                    # This file
├── dev.thepia.net.crt          # Let's Encrypt certificate
├── dev.thepia.net-key.pem      # Let's Encrypt private key
├── dev.thepia.net.pem          # Combined Let's Encrypt file
├── localhost.pem               # Self-signed localhost cert
├── localhost-key.pem           # Self-signed localhost key
├── thepia.local.pem            # Self-signed local network cert
└── thepia.local-key.pem        # Self-signed local network key
```

This setup ensures that Nets Offboarding Flows development works seamlessly with thepia.net authentication and provides a production-like HTTPS environment for comprehensive testing.